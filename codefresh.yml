version: '1.0'
steps:
  BuildApiImages:
    type: parallel
    steps:
      BuildingDecryptorDockerImage:
        title: Building Decryptor Docker Image
        type: build
        image_name: soluto/kamus
        working_directory: ./
        tag: '${{CF_BRANCH_TAG_NORMALIZED}}-decryptor'
        dockerfile: Dockerfile
      BuildingEncryptorDockerImage:
        title: Building Encryptor Docker Image
        type: build
        image_name: soluto/kamus
        working_directory: ./
        tag: '${{CF_BRANCH_TAG_NORMALIZED}}-encryptor'
        dockerfile: Dockerfile
        build_arguments:
          - PROJECT_NAME=encrypt-api
      RunIntegrationTests:
        title: Run integration tests
        image: microsoft/dotnet:2.1-sdk
        working_directory: tests/integration
        commands:
          - dotnet build
          - dotnet test
  BlackBoxTests:
    title: Run black box tests
    type: composition
    composition: './tests'
    composition_candidates:
      black-box:
        command: ./run_test.sh