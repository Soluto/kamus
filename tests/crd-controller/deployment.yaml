apiVersion: v1
kind: ServiceAccount
metadata:
  name: crd-controller
---
apiVersion: v1
kind: Secret
metadata:
  name: tls-certificate
type: Opaque
data:
  certificate.pfx: MIIJAQIBAzCCCMcGCSqGSIb3DQEHAaCCCLgEggi0MIIIsDCCA2cGCSqGSIb3DQEHBqCCA1gwggNUAgEAMIIDTQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQYwDgQInlgTs7YabLECAggAgIIDIKLxyB4YFc9y9rEr3vHEY2pSmfSFHarPpmVtpYPJl2z0OMqI5jX+Ft1VUjP5sbzBWRcixfdYTIoT4gtaFDfYG1aNtqvrt6ewhrLAWNDiQ5UrzIXbtNNP9cgTcPgJqpQNI1QsAQiJk5bvzSTACXbp37uRo1O8fc4wVJj02YQHeHWeSOXnMg4rPFTjWcTOdVhtWHS4H19H6ePqdylfDU9e6LU2yGRpdKE9Vzcb3pTULcUiHl/7+aXY/IbUK89mAMkFfmviM2GCg6WUAjMyLfFMCt+DBxRIThgGKK8dzrE9fRvknpc8JC5KeoPeQrC9bVp7vAf4P3I2HI/ejTEZSd9vU0qkMaKJ++s2JFuHJdkqZv51CZyxsohHZBVICB1H4HzjU2w95Z7HSiTcln6ARrJpdmZJFedZJqZl6+j9e1/VIbYtSD+n17N4dLtJEWppjHbUfCL9o+HSo0k5bc1X+6KWH6cY0y7swBcCdiQ3aIpqBOJScc+fDosfUuK07HKnUCC/Vww4PS8Tj3zLDCNzjI5Ora+lAl8fwom/dP1O2W7lWzA7BT7nOCZXu2VLjMNhm8pDTllEPVwsQ0gKFB8iO3RH84E0bmkZdbE7s0WvIfaMGPdmq3S/yp2DNl7BQr0M9O/B8HZVGC8Cs8S4RLjPDyQu+zDB3aMJSKBX9RvvjFQw2Lou+7sIkeVjeg95V6qeQB0WBcC0NqLJ9j9vfevIljxTcF0M4BN5jZHFDoeBip5yYlRPKpw5dhghUo9EMtgUs0G1S/v1tXLrxmCfOPA+1oLJBqVrZ8DPHOXP59iMvpL2BdqRx8zLrTQYneUgFqEYR7ycvnNKELtP4tv6ZPZG2R61nfOroGTA4Zi7/mGajJSGPqD3hrOXkOZh+x/nKkTvo9q8kahP/Dfyjzd8LVqD7x1GzNZf7bfbwPRh31p5jkrwI6dwcE17SeSobctq8h4EQc1ZNw26UO569vQ2APlj1gRUH3/KAMv0dp6lBnKtU65dwt3P1LFHrpRqX0UJzorOzLOcpu9vqrxLtIW2Xrc3teJAT260lAr0xYCCzknRrdhzkItUMIIFQQYJKoZIhvcNAQcBoIIFMgSCBS4wggUqMIIFJgYLKoZIhvcNAQwKAQKgggTuMIIE6jAcBgoqhkiG9w0BDAEDMA4ECMbIhBfve/llAgIIAASCBMhlZoBazevIRW3WCKgeuMG++GYFu8dTn5ljqsUWNRZ7PdWCaGRlxrTqRJz2/pZPc4fHa1d1wWqFURgU2Hjv0vJyVQVd6J0qp3LYudE++/T7lOP7l9CpYHZmaJJ+TM21aREPyGwkXBNfk+/aj7LKAn3rsIeD7Y3TK9H1dJwBr+cFFsornbyXCtxKpxILRghw8OCD0TcS8ghytdObEFlS7YCKKSupvfHNLgeDpFuDTSq9Nm7lkT0E6uHz1VUHtXgXLnIE3VPpr3jn2wQqlG+/FGNQYKUqN6zO6xhBF/4omsErnzKLbQoMjrf+P/usV3ex3OR5kZtZgwX5F1mzTzHhCuouUpwOiA6//W9o5nPuT2jbOapeXNcsXn8K+kVlcXI+ZZH5hg8z85esTif10eybBRSAR3GmDTqC6000ISBQyMWHxksoxRBCa5TloXNnX6HKAEAmTqj7lIHGM4/BJMNlnPeMIbRjGuJOdqW5o+ZFzNR4c8j54GA1wGu6YuNdAQZPSJycpgwW1RK+k+iRnM3rI2/gpRFzdKubtZNqgHVvC2W4krxwfditPV0pSfJaJCxk6jtTpTuGaRP24XyoKbDL2CjCysgpqz7vJJeClxIn/2GfhdO8s0Y4d5usrDzViafI5k4ykMqRYp9rqfOXhmtbhTROOZwJKuyoWUrCmVQb9+wnuUCMItfqEXyLVcNBU1MwzIq7hkzh+KnpJR5OIuw9PWG4IQ0Inx3qTG7hsvmz/7sjRx75YyCU9I6LI//csR13+RITXVvf+5aL3HK5Jr8sopALnZYRB/E4aG70tAIEfP8I+YAmqnjXgvj2ufy0DPIT+Gg7pk79zKgOAR52fF+WbXzp6OUOEDDK7bn2+TFOqQgS3jh70CRx6PGXHCEUm6YCkUbBk4qJ1BBzvSMNEN7txR7UmfLJfQsLr5lnFxdcj3c3EsgyeRT/ap97ZFkeIJ3SZmRyckzcR42FHg0uRJyNLYP9NXuthv74E+OzDPEsLk4lBmjmJs3JxQlHaqtKbDPogbUmLmKKEZV0UvgWA7Dl1lxBeEuqKB3JBsFFpOW0L8f0HzamowD/mOF4PwyOxPXdoh2MC9kUBZfIvSIYnuMOwNSG3Dl6uRiovwBiixtnUfGu0Xyuekefit7NHxYqA49ZtveaAA/2G4/gfBZfbPaiUM0YXQeFaP1ngWc4+4eekMg9Hay3X8CMMhK2kE+KVKEM887WJeAkQ9NBgfgOBNiL3XnYGlZj+eYEelBeJ7w91AUcoqCS62B4cCwHY/cgHFMzd+4/UC1bP3mjcTjTkELvaTkGffgqM0B0Q2jKJkWpCo6oSm/Y0Z17vNF2oxtb2MEZpbU4BU1PYL95QrNlacVtj0KDKO3/NXk6ro4vp9OLrd39z0vLhesisIb89ejzKDM0PQlh5dUBYTgizgoQpDI1itWIKO2T3dTZPFzsxbYv1HZpbMozpG5YhJWuPWv1xYnUByr01+iUnDsupF1FtO65JPY/vKgEwzsk5E63InEcl44+hlGfDJN25MbOeOicq+C6zHmjOnVlbFWyqRGJ1mtNUNR+XPzgOzK52VVYbn5hUoDMfTAap16B+99TI/IxBbJlI6z7Ic0oWsxDAwbVGYMYtS0Jf14idEJPJ4AxJTAjBgkqhkiG9w0BCRUxFgQUyihw+C5PYWMwEFas1Y6J9hoPAecwMTAhMAkGBSsOAwIaBQAEFOxKwiP3oXzlHLBaozLTD/GbrWrSBAivD4xGI2TNxQICCAA=
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: kamus-crd
rules:
- apiGroups: ["soluto.com"] # "" indicates the core API group
  resources: ["kamussecrets"]
  verbs: ["watch"]
- apiGroups: [""] # "" indicates the core API group
  resources: ["secrets"]
  verbs: ["create", "delete", "patch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: crd-controller
subjects:
- kind: ServiceAccount
  name: crd-controller
  namespace: default
roleRef:
  kind: ClusterRole
  name: kamus-crd
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Service
metadata:
  name: kamus-crd
  labels:
    app: kamus
    component: crd-controller
    chart: kamus-0.3.0
    heritage: Tiller
spec:
  type: ClusterIP
  ports:
    - port: 443
      targetPort: 8888
      protocol: TCP
      name: http-kamus-controller
  selector:
    app: kamus
    component: crd-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kamus-crd-controller
  labels:
    app: kamus
    component: crd-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kamus
      component: crd-controller
  template:
    metadata:
      labels:
        app: kamus
        component: crd-controller
    spec:
      serviceAccountName: crd-controller
      containers:
      - name: controller
        image: crd-controller
        imagePullPolicy: IfNotPresent
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:9999;https://+:8888"
        - name: ASPNETCORE_Kestrel__Certificates__Default__Path
          value: "/home/dotnet/https/certificate.pfx"
        - name: ASPNETCORE_Kestrel__Certificates__Default__Password
          value: "aaaa"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9999        
        readinessProbe:
          httpGet:
            path: /healthz
            port: 9999
        volumeMounts:
          - name: foo
            mountPath: "/home/dotnet/https/"
            readOnly: true
      volumes:
      - name: foo
        secret:
          secretName: tls-certificate