apiVersion: v1
kind: ServiceAccount
metadata:
  name: crd-controller
---
apiVersion: v1
kind: Secret
metadata:
  name: tls-certificate
type: Opaque
data:
  certificate.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRQzY4djNtdWorS0REQU5CZ2txaGtpRzl3MEJBUXNGQURBZ01SNHdIQVlEVlFRRERCVnIKWVcxMWN5MWpjbVF1WkdWbVlYVnNkQzV6ZG1Nd0hoY05NVGt3T1RFeE1URXpPVEF5V2hjTk1qQXdPVEV3TVRFegpPVEF5V2pBZ01SNHdIQVlEVlFRRERCVnJZVzExY3kxamNtUXVaR1ZtWVhWc2RDNXpkbU13Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURYQS9xTHVSeGROZmZBNmdidjcwRFRYSVFGWHM1ZDFHRWEKbytraWpoeTJ2VXFRTWpDMW9NZXJDRmlUSFBRNnRVa0xrVDl4RlljV1RuWlFtRG5pZnpkVmphUFBCV3VSbVFPTAo3RW8rYjVaNVVnSW9vWEgzeE1VSllkcUZQNkQ2Zzl0YmdPdndIZUNtOW1XTkR6NTRKRHpNdkh5NlNtOUdqS3ByCnIxUG44c1NQL2FpNEREM0RBdTJiZFNMTWlVbWdXbmVEQS9BVlZoVUNTVFFqaUlmZnFVNUxSQ2c1bGYwRWc1c3AKNWk5UUJKcGN2NGQ1RTA5dWlnUXB4dGcrQzMycXFuQjJ4Ym9ZSUdxOXV1SVNUNTJqNTh5ZHNqVHE4RDJvbHZDNAphR1daSzBpc2lzcmpvMys5WXhRbUJCbE8zTWtPNUJVQ0taUWN4STlWMVlJVjVGZ2tnOFRMQWdNQkFBRXdEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUxwM25qODZSTG5tN003TkNldjNRb1Q5Wm8vSlpjMjdFSUF0aDJPK3FkeXcKTjZPbW95Qllkb0hsb0VtTW1aVFB1UjF5MS9rWXRXZFRoT1JGRCtmRE5uam5ab3N2bjZiWVYrNFROTTBENjYvZwpQL05lWDFTT1M5OEJ6TDBXcVFraFNWTDNjME1Pb1dXZCt4QXEwR0ZPSWZWd2FEWStaU0JZVUFaOFpLUXIzK01nCjBPazJzZ0ZTLzNKWFZKb3RrbENLRVJYcE9uNll2MU9tY2xvVGFGT05xb3o4OVkvWnNNVWMzbXJsWjNmc3I4MEIKclkxaklTSzg0VjhSaSsvcWpaNXNRdzBGSEhDWjk0R2czQVR5OFJKL2Q5cHBvQ3g4TXUzRk1aYTJpS0NmVHlSUgorVXp6UjZvNHIzREdiMzJEem5oZ3Q5aXNCU0RYLzJ5UkxwZk9WdmdTVWl3PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  privateKey.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRFhBL3FMdVJ4ZE5mZkEKNmdidjcwRFRYSVFGWHM1ZDFHRWFvK2tpamh5MnZVcVFNakMxb01lckNGaVRIUFE2dFVrTGtUOXhGWWNXVG5aUQptRG5pZnpkVmphUFBCV3VSbVFPTDdFbytiNVo1VWdJb29YSDN4TVVKWWRxRlA2RDZnOXRiZ092d0hlQ205bVdOCkR6NTRKRHpNdkh5NlNtOUdqS3BycjFQbjhzU1AvYWk0REQzREF1MmJkU0xNaVVtZ1duZURBL0FWVmhVQ1NUUWoKaUlmZnFVNUxSQ2c1bGYwRWc1c3A1aTlRQkpwY3Y0ZDVFMDl1aWdRcHh0ZytDMzJxcW5CMnhib1lJR3E5dXVJUwpUNTJqNTh5ZHNqVHE4RDJvbHZDNGFHV1pLMGlzaXNyam8zKzlZeFFtQkJsTzNNa081QlVDS1pRY3hJOVYxWUlWCjVGZ2tnOFRMQWdNQkFBRUNnZ0VBWFRFZlJiSDhwalcrNVVGSnNuSzdZU0NuSkFDOFp4U201Ym9IVU8vUmFDN1IKQTRDTmRodHlqeUcxNmtWUllhU3pQUzArRnhCaWxYdDZjbUlZTEtCQTVuYldlZUw2aFllUmJ2TUNGdCtjazRiRQo0c0ZldVNueTBLYzE1Q3o0NDd1RXRydEJCN2liWnlKQ1Q0bzg1Q3Vvb29CTGV4N0o3Z1VIMUZhUWdtYkpaVEtiCnBnVk9mVWxmS0x4NXZzb1g5VnlCMnpPMlgzdU1xZm50WGtQeHEvUUFYYVNJdElGZ0xFeEUzRmpPTm11V3djSWwKdWZYWXRGaFo1QW1iVEZqS1JyN1VIcFg3bXpGaFVESUxPa1VzQzVrbFJTZEtRSE5tRGhpR3RkU3BCbWxmYXFOSAordk1ibnc1NEpRdDhRYzdGZjdnODhXS1B0T2hVdDM5U3BhT2N3RVFHRVFLQmdRRHU3c3paNmF0MXFHejlFNTVhCnI0R2FjK1RCYUIrRUhyU0FhSGFvZ2V0ZWNuZUNqODYvcmpZRjBDSkFSM0tkeTJuN0ZMNVFUWEg2Z01LeDkwVE0KS3VENGVGQ0s1ZVU0WjRaUEFiaWhnR25MYjNUMEcxVkxMWk4yNmxJTkVTL0dHKzJNOURBQ1lRT3plbGpOQ3RXbApUb29OQ3Q2YlR2S05UT0psOWNSL2dQMUxxUUtCZ1FEbVg5SGY1RVFkWFI4STVlSHNVcldxOFhUZ2dtd3BkMEViCnFUL1JuVEZnQjFUeThld3ZTaUhZSlU1Kzd4cE1qTzJNZjhVWTJXWWpUbWk1MlBlU1Q2UXF6cVZCV3RVcFhUYkEKYms2aE5xL21JL055T0VWQ3hMWnBZOXFIK3pqQVlhdTh5dzdRb0RWMWEvYU8vZHM0RDZWZzdvYzE2ZHVlWUZXZgp5aGE0MmxCMVV3S0JnUURHeHo4QUVDb0lZYzRDb2w2OC9ZUnFkZjZiZFQrN0VEeUZFK09iL3pKTXloaHBNN0VDCndUSEtsa1RZaTFoc3RMMkFHTnJZUGdZVUxTbE5HL1ZOa21MRjlIcTFnOXUybUZJaHlzSExBdVdCVFVIVWtDVGUKdlpVUWVwTTJzZFM0RWFZSS9XSXZxSHlHeGNPNUdrbHlGS3cvZTRxRlZTSHZza1lzSTFLTjdVZE51UUtCZ1FETApyRWxzRFc3Zkd4WTJFcSt6OU1maWN3am0rTWZSdlRwVnowTzUrYVRPaG96bklWV3oxWEdvbkFzVEZDZUhLRTFZCm14blJSMXNTdWQ3QytIeWc0VUorQ2laMmFtenMzaGxxOWRzVWtybmUyVWdCWXBoeFdHTUJPQ1BiZHhNTW13MXYKbzRMY2xkZk5rWDd4bXFRMm96YU9SVFJMU1E4K3JXTG1HNUFOTEE1WU93S0JnSG5nY290OWpnc1dsWWZUN2FuNAplbzRGZkt5QmpXd2ZqNTkzRnI3bUJsT3VSYW1SemYrQlJadE5LTXpHcFhuUGs5MUt5eFN4SDhCaUdWbnRFUE5QCk9zeVE5ODRkK3pIYXlvZnZwYWtIa0N1SXlrcDcvbVh6Z1Nmb3lJL3krdlNvNFN4V2ZXWXBSaUV6YXBQb09kTk4KMitZalY2bW5ROUFWNG5sTVVBOXI2YVdoCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: kamus-crd
rules:
- apiGroups: ["soluto.com"] # "" indicates the core API group
  resources: ["kamussecrets"]
  verbs: ["watch"]
- apiGroups: [""] # "" indicates the core API group
  resources: ["secrets"]
  verbs: ["create", "delete", "patch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: crd-controller
subjects:
- kind: ServiceAccount
  name: crd-controller
  namespace: default
roleRef:
  kind: ClusterRole
  name: kamus-crd
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Service
metadata:
  name: kamus-crd
  labels:
    app: kamus
    component: crd-controller
    heritage: Tiller
spec:
  type: ClusterIP
  ports:
    - port: 443
      targetPort: 8888
      protocol: TCP
      name: http-kamus-controller
  selector:
    app: kamus
    component: crd-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kamus-crd-controller
  labels:
    app: kamus
    component: crd-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kamus
      component: crd-controller
  template:
    metadata:
      labels:
        app: kamus
        component: crd-controller
    spec:
      serviceAccountName: crd-controller
      containers:
      - name: controller
        image: crd-controller
        imagePullPolicy: IfNotPresent
        env:
        - name: TLS_CERT_FOLDER
          value: "/home/dotnet/https"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9999        
        readinessProbe:
          httpGet:
            path: /healthz
            port: 9999
        volumeMounts:
          - name: foo
            mountPath: "/home/dotnet/https/"
            readOnly: true
      volumes:
      - name: foo
        secret:
          secretName: tls-certificate
